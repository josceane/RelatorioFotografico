<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Relatório de Fiscalização</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f8f9fc;
    }
    h1 {
      text-align: center;
    }
    form {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      max-width: 900px;
      margin: auto;
    }
    .grid {
  display: grid;
  grid-template-columns: 45% 45%; /* duas colunas menores */
  justify-content: space-between; /* cria espaço entre elas */
  gap: 20px; /* aumenta a distância vertical */
}
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .foto-container {
      margin-top: 15px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
    .foto-item {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 6px;
      background: #fafafa;
      text-align: center;
    }
    .foto-item img {
      max-width: 100%;
      height: auto;
      margin-bottom: 5px;
    }
    .legenda {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
    }
  </style>
</head>
<body>
  <h1>RELATÓRIO DE FISCALIZAÇÃO</h1>
  <form id="relatorioForm">
    <div class="grid">
      <div>
        <label>Local:</label>
        <input type="text" id="local">
      </div>
      <div>
        <label>Relatório nº:</label>
        <input type="text" id="numero">
      </div>
      <div>
        <label>Data:</label>
        <input type="date" id="data">
      </div>
      <div>
        <label>Órgãos envolvidos:</label>
        <input type="text" id="fiscais">
      </div>
    </div>

    <label>Solicitante:</label>
    <input type="text" id="solicitante">

    <label>Referência / Assunto:</label>
    <textarea id="referencia"></textarea>

    <h2>RELATÓRIO FOTOGRÁFICO</h2>
    <input type="file" id="fotos" multiple accept="image/*">
    <div class="foto-container" id="preview"></div>

    <button type="button" onclick="gerarPDF()">Gerar PDF</button>
  </form>

  <script>
    const { jsPDF } = window.jspdf;

    document.getElementById('fotos').addEventListener('change', function(){
      const preview = document.getElementById('preview');
      preview.innerHTML = "";
      let count = 0;
      for(let file of this.files){
        if(count >= 18) break; // Limita a 18 imagens
        count++;
        const reader = new FileReader();
        reader.onload = function(e){
          const div = document.createElement('div');
          div.classList.add('foto-item');
          div.innerHTML = `
            <img src="${e.target.result}" alt="foto">
            <input type="text" placeholder="Legenda da foto" class="legenda">
          `;
          preview.appendChild(div);
        }
        reader.readAsDataURL(file);
      }
    });

    // Função para comprimir imagem (canvas)
    function compressImage(imgSrc, maxWidth = 800, quality = 0.6) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          let scaleSize = maxWidth / img.width;
          if (img.width < maxWidth) scaleSize = 1; // não aumentar imagem menor
          canvas.width = img.width * scaleSize;
          canvas.height = img.height * scaleSize;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          resolve(canvas.toDataURL("image/jpeg", quality));
        }
        img.src = imgSrc;
      });
    }

    async function gerarPDF(){
      const doc = new jsPDF();

      doc.setFontSize(14);
      doc.text("RELATÓRIO DE FISCALIZAÇÃO", 105, 15, {align:"center"});
      doc.setFontSize(11);

      let y = 30;
      function addText(label, value){
        if(value){
          const linhas = doc.splitTextToSize(`${label}: ${value}`, 180);
          doc.text(linhas, 15, y);
          y += (linhas.length * 6) + 2;
        }
      }

      addText("Local", document.getElementById('local').value);
      addText("Relatório nº", document.getElementById('numero').value);
      addText("Data", document.getElementById('data').value);
      addText("Órgãos envolvidos", document.getElementById('fiscais').value);
      addText("Solicitante", document.getElementById('solicitante').value);
      addText("Referência / Assunto", document.getElementById('referencia').value);

      y += 5;
      doc.text("RELATÓRIO FOTOGRÁFICO", 15, y);
      y += 10;

      const fotos = document.querySelectorAll('.foto-item');
      let x = 15;
      for (let foto of fotos) {
        const img = foto.querySelector('img');
        const legenda = foto.querySelector('.legenda').value;

        // Comprimir antes de adicionar
        const compressed = await compressImage(img.src);

        doc.addImage(compressed, 'JPEG', x, y, 80, 60);
        doc.text(doc.splitTextToSize(legenda, 80), x, y + 65);

        if(x === 15){
          x = 110; // próxima imagem na mesma linha
        } else {
          x = 15;
          y += 80; // nova linha de fotos
        }

        /* Marca d’água */
.formulario::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 600px;          /* largura da marca d’água */
  height: 600px;         /* altura da marca d’água */
  background: url('fundo.png') no-repeat center center;
  background-size: contain;
  opacity: 0.08;         /* transparência da marca d’água */
  transform: translate(-50%, -50%);
  z-index: 0;
}  
        if(y > 240){
          doc.addPage();
          y = 20;
          x = 15;
        }
      }

      doc.save("relatorio.pdf");
    }
  </script>
</body>
</html>
